<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>平台用户服务及信用管理协议（多语言+积分+艺术字签名+随机合同编号+截止日期）</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&family=Great+Vibes&display=swap" rel="stylesheet">
<style>
body{font-family:'Noto Sans SC',sans-serif;background:#f4f6f8;padding:20px}
.container{max-width:900px;margin:0 auto;background:#fff;padding:24px;border-radius:10px;box-shadow:0 6px 24px rgba(0,0,0,.08)}
input{padding:6px;margin:2px 0;width:100px;text-align:center;border:none;background:transparent}
select{padding:6px;margin:2px 0;width:100px}
table{width:100%;border-collapse:collapse;margin:12px 0}
th,td{padding:10px;border:1px solid #e6e9ee;text-align:left}
th{background:#fafbfd;color:#6b7280;font-weight:700}
.badge{display:inline-block;padding:4px 10px;border-radius:6px;font-weight:700}
.green{color:green}.orange{color:orange}.red{color:red}
.signature-area{display:flex;gap:12px;flex-wrap:wrap;align-items:center; font-family:'Great Vibes', cursive; font-size:36px}
.btn{padding:6px 12px;border-radius:6px;border:none;background:#0f62fe;color:#fff;cursor:pointer;margin-top:4px}
.btn.secondary{background:#fff;color:#0f62fe;border:1px solid #0f62fe}
.controls{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
h1{text-align:center}
.contract-number{margin-top:8px;text-align:center;font-weight:700;font-size:16px}
@media print{.controls{display:none}}
/* small responsive tweak */
@media (max-width:600px){.signature-area{font-size:28px}}
</style>
</head>
<body>
<div class="container" id="contract">
  <div class="controls no-print">
    <select id="langSelect" aria-label="Language select">
      <option value="zh">中文</option>
      <option value="en">English</option>
      <option value="pt">Português (Brasil)</option>
      <option value="es">Español</option>
    </select>
    <!-- 可选：允许用户调整截止天数 -->
    <label style="align-self:center;margin-left:8px">有效期(天)</label>
    <input id="expiryDays" type="number" value="30" min="1" style="width:60px" />
  </div>

  <h1 id="contractTitle" data-i18n="title">平台用户服务及信用管理协议</h1>
  <div class="contract-number" id="contractNumberDisplay" data-i18n="contractNumber">合同编号：</div>

  <table>
    <tr><th data-i18n="signDate">签署日期</th><td id="signDate">-</td></tr>
    <tr><th data-i18n="expireDate">截止日期</th><td id="expireDate">-</td></tr>

    <tr><th data-i18n="userName">用户姓名/企业名称</th><td><span id="userNameSpan" contenteditable="true"></span></td></tr>
    <tr><th data-i18n="idNo">证件类型及号码</th><td><span id="idNoSpan" contenteditable="true"></span></td></tr>
    <tr><th data-i18n="contact">注册账号 / 联系信息</th><td><span id="accountSpan" contenteditable="true"></span></td></tr>

    <tr><th data-i18n="creditStatus">信用积分状况</th>
      <td>
        <span data-i18n="initialScore">初始积分：</span><input type="number" id="initialScore" value="100" onchange="updateActual()"> <br>
        <span data-i18n="deductScore">扣减分数：</span><input type="number" id="deductScore" value="30" onchange="updateActual()"> <br>
        <span data-i18n="reqScore">提款需达到：</span><input type="number" id="reqScore" value="90" onchange="updateActual()"> <span data-i18n="points">分</span> <br>
        <span data-i18n="actualScoreText">实际积分：</span><input type="number" id="actualScore" value="70" readonly> &nbsp;
        <span data-i18n="withdrawStatusText">提款状态：</span><span id="withdrawStatus" class="badge red" data-i18n="withdrawStatusVal">禁止提款</span>
      </td>
    </tr>

    <tr><th data-i18n="acctStatus">账户状态</th><td><span id="acctStatusSpan" contenteditable="true"></span></td></tr>
    <tr><th data-i18n="service">服务内容</th><td data-i18n="serviceVal">平台提供账户管理、交易处理、信用评估等服务。</td></tr>
    <tr><th data-i18n="rules">信用管理条款</th><td data-i18n="rulesVal">1. 如因违规导致评分下降平台可限制功能。2. 积分下降后需恢复至 90 分方可提款。</td></tr>
    <tr><th data-i18n="fee">费用及结算方式</th><td data-i18n="feeVal">无手续费 / 按标准收费。</td></tr>
    <tr><th data-i18n="dispute">争议解决方式</th><td data-i18n="disputeVal">按平台所在地法律仲裁。</td></tr>
    <tr><th data-i18n="confirm">用户确认</th><td data-i18n="confirmVal">本人确认上述信息真实无误。</td></tr>

    <tr><th data-i18n="signature">用户签名</th>
      <td>
        <div id="signatureDisplay" class="signature-area" contenteditable="true">请输入英文姓名</div>
      </td>
    </tr>

    <tr><th data-i18n="sysNote">系统备注</th><td data-i18n="sysNoteVal">系统自动生成，无需手写。</td></tr>
  </table>

  <div class="controls no-print">
    <button class="btn" onclick="window.print()" data-i18n="printBtn">打印 / 导出 PDF</button>
    <button class="btn secondary" onclick="exportAsPDF()" data-i18n="exportPDFBtn">导出整页 PDF</button>
    <button class="btn secondary" onclick="downloadPNG()" data-i18n="exportPNGBtn">导出整页 PNG</button>
  </div>
</div>

<!-- 库：html2canvas + jspdf -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
// 多语言字典（包含截止日期及提款三种状态文本）
const i18n = {
  zh: {
    title:"平台用户服务及信用管理协议",
    contractNumber:"合同编号：",
    signDate:"签署日期",
    expireDate:"截止日期",
    userName:"用户姓名/企业名称",
    idNo:"证件类型及号码",
    contact:"注册账号 / 联系信息",
    creditStatus:"信用积分状况",
    initialScore:"初始积分：",
    deductScore:"扣减分数：",
    reqScore:"提款需达到：",
    points:"分",
    actualScoreText:"实际积分：",
    withdrawStatusText:"提款状态：",
    withdrawStatusVal:"禁止提款",
    withdrawStatusAllowed:"允许提款",
    withdrawStatusWaiting:"等待提款",
    acctStatus:"账户状态",
    service:"服务内容",
    serviceVal:"平台提供账户管理、交易处理、信用评估等服务。",
    rules:"信用管理条款",
    rulesVal:"1. 如因违规导致评分下降平台可限制功能。2. 积分下降后需恢复至 90 分方可提款。",
    fee:"费用及结算方式",
    feeVal:"无手续费 / 按标准收费。",
    dispute:"争议解决方式",
    disputeVal:"按平台所在地法律仲裁。",
    confirm:"用户确认",
    confirmVal:"本人确认上述信息真实无误。",
    signature:"用户签名",
    sysNote:"系统备注",
    sysNoteVal:"系统自动生成，无需手写。",
    printBtn:"打印 / 导出 PDF",
    exportPDFBtn:"导出整页 PDF",
    exportPNGBtn:"导出整页 PNG"
  },
  en: {
    title:"Platform User Service & Credit Agreement",
    contractNumber:"Contract No.:",
    signDate:"Sign Date",
    expireDate:"Expiration Date",
    userName:"User Name / Company",
    idNo:"ID Type & Number",
    contact:"Registered Account / Contact Info",
    creditStatus:"Credit Status",
    initialScore:"Initial Score:",
    deductScore:"Deducted Points:",
    reqScore:"Required for Withdrawal:",
    points:"points",
    actualScoreText:"Actual Score:",
    withdrawStatusText:"Withdrawal Status:",
    withdrawStatusVal:"Not Allowed",
    withdrawStatusAllowed:"Allowed",
    withdrawStatusWaiting:"Pending Withdrawal",
    acctStatus:"Account Status",
    service:"Service Content",
    serviceVal:"The platform provides account management, transaction processing, credit evaluation services, etc.",
    rules:"Credit Management Terms",
    rulesVal:"1. Platform may restrict functions if credit drops due to violations. 2. Withdrawals require credit recovery to 90 points.",
    fee:"Fees & Settlement",
    feeVal:"No fees / Standard charges apply.",
    dispute:"Dispute Resolution",
    disputeVal:"Arbitration according to the platform's jurisdiction.",
    confirm:"User Confirmation",
    confirmVal:"I confirm the above information is true and accurate.",
    signature:"User Signature",
    sysNote:"System Note",
    sysNoteVal:"Automatically generated by system, no handwriting required.",
    printBtn:"Print / Export PDF",
    exportPDFBtn:"Export Full PDF",
    exportPNGBtn:"Export Full PNG"
  },
  pt: {
    title:"Acordo de Serviço e Crédito da Plataforma",
    contractNumber:"Número do Contrato:",
    signDate:"Data de Assinatura",
    expireDate:"Data de Expiração",
    userName:"Nome do Usuário / Empresa",
    idNo:"Tipo e Número de Documento",
    contact:"Conta Registrada / Informações de Contato",
    creditStatus:"Status de Crédito",
    initialScore:"Pontuação Inicial:",
    deductScore:"Pontos Deduzidos:",
    reqScore:"Necessário para Retirada:",
    points:"pontos",
    actualScoreText:"Pontuação Atual:",
    withdrawStatusText:"Status de Retirada:",
    withdrawStatusVal:"Não Permitido",
    withdrawStatusAllowed:"Permitido",
    withdrawStatusWaiting:"Aguardando Retirada",
    acctStatus:"Status da Conta",
    service:"Conteúdo do Serviço",
    serviceVal:"A plataforma fornece gerenciamento de conta, processamento de transações, avaliação de crédito, etc.",
    rules:"Termos de Gerenciamento de Crédito",
    rulesVal:"1. A plataforma pode restringir funções se o crédito cair devido a violações. 2. Retiradas exigem recuperação do crédito para 90 pontos.",
    fee:"Taxas e Liquidação",
    feeVal:"Sem taxas / Cobranças padrão aplicáveis.",
    dispute:"Resolução de Disputas",
    disputeVal:"Arbitragem de acordo com a jurisdição da plataforma.",
    confirm:"Confirmação do Usuário",
    confirmVal:"Confirmo que as informações acima são verdadeiras e precisas.",
    signature:"Assinatura do Usuário",
    sysNote:"Nota do Sistema",
    sysNoteVal:"Gerado automaticamente pelo sistema, sem necessidade de escrita manual.",
    printBtn:"Imprimir / Exportar PDF",
    exportPDFBtn:"Exportar PDF Completo",
    exportPNGBtn:"Exportar PNG Completo"
  },
  es: {
    title:"Acuerdo de Servicio y Crédito de la Plataforma",
    contractNumber:"Número de Contrato:",
    signDate:"Fecha de Firma",
    expireDate:"Fecha de Expiración",
    userName:"Nombre de Usuario / Empresa",
    idNo:"Tipo y Número de Documento",
    contact:"Cuenta Registrada / Información de Contacto",
    creditStatus:"Estado de Crédito",
    initialScore:"Puntaje Inicial:",
    deductScore:"Puntos Deducidos:",
    reqScore:"Requerido para Retiro:",
    points:"puntos",
    actualScoreText:"Puntaje Actual:",
    withdrawStatusText:"Estado de Retiro:",
    withdrawStatusVal:"No Permitido",
    withdrawStatusAllowed:"Permitido",
    withdrawStatusWaiting:"En Espera de Retiro",
    acctStatus:"Estado de la Cuenta",
    service:"Contenido del Servicio",
    serviceVal:"La plataforma proporciona gestión de cuentas, procesamiento de transacciones, evaluación de crédito, etc.",
    rules:"Términos de Gestión de Crédito",
    rulesVal:"1. La plataforma puede restringir funciones si el crédito disminuye debido a violaciones. 2. Los retiros requieren que el crédito se recupere a 90 puntos.",
    fee:"Tarifas y Liquidación",
    feeVal:"Sin tarifas / Se aplican cargos estándar.",
    dispute:"Resolución de Disputas",
    disputeVal:"Arbitraje de acuerdo con la jurisdicción de la plataforma.",
    confirm:"Confirmación del Usuario",
    confirmVal:"Confirmo que la información anterior es verdadera y precisa.",
    signature:"Firma del Usuario",
    sysNote:"Nota del Sistema",
    sysNoteVal:"Generado automáticamente por el sistema, no se requiere escritura a mano.",
    printBtn:"Imprimir / Exportar PDF",
    exportPDFBtn:"Exportar PDF Completo",
    exportPNGBtn:"Exportar PNG Completo"
  }
};

// 保证合同编号只生成一次
const contractNumber = generateContractNumber();
const langSelect = document.getElementById('langSelect');
const expiryDaysInput = document.getElementById('expiryDays');

// 应用语言包（会更新合同编号显示，并刷新日期）
function applyLanguage(lang){
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key = el.getAttribute('data-i18n');
    if(i18n[lang] && i18n[lang][key]) {
      el.textContent = i18n[lang][key];
    }
  });
  // 合同编号：使用页面加载时生成的编号（切换语言不改变编号）
  document.getElementById('contractNumberDisplay').textContent = i18n[lang].contractNumber + ' ' + contractNumber;
  // 刷新显示日期（签署 + 截止）
  refreshSignDate();
  refreshExpireDate();
}
langSelect.addEventListener('change',()=>applyLanguage(langSelect.value));

// 默认语言
applyLanguage('zh');

// ---------- 日期函数（使用巴西时区 America/Sao_Paulo） ----------
function formatDateInBrazil(dateObj) {
  return new Intl.DateTimeFormat('pt-BR', {
    timeZone: 'America/Sao_Paulo',
    day: '2-digit',
    month: '2-digit',
    year: 'numeric'
  }).format(dateObj);
}
function brazilDateStringNow(){
  return formatDateInBrazil(new Date());
}
function refreshSignDate(){
  // 当前时间（页面加载或切换语言时更新）
  const signEl = document.getElementById('signDate');
  signEl.textContent = brazilDateStringNow();
}
// 计算截止日期：签署日期 + expiryDaysInput（天）
function calcExpireDate(){
  // 我们根据当前真实时刻作为签署时间（与 signDate 保持一致）
  const now = new Date();
  const days = parseInt(expiryDaysInput.value) || 30;
  const expire = new Date(now.getTime());
  expire.setDate(expire.getDate() + days);
  return formatDateInBrazil(expire);
}
function refreshExpireDate(){
  document.getElementById('expireDate').textContent = calcExpireDate();
}
// 当用户修改有效期天数时也刷新截止日期
expiryDaysInput.addEventListener('change', () => {
  refreshExpireDate();
});

// ---------- 合同编号生成（只生成一次） ----------
function generateContractNumber(){
  const parts=["CPT","BR","RF",2025];
  const randNum=Math.floor(Math.random()*9000)+1000;
  // 再添加时间戳短后缀，便于唯一性
  const ts = Date.now().toString().slice(-5);
  return `${parts.join('-')}-${randNum}-${ts}`;
}

// ---------- 积分逻辑（使用 i18n 的文本） ----------
function updateActual(){
  let initial=parseInt(document.getElementById('initialScore').value) || 0;
  let deduct=parseInt(document.getElementById('deductScore').value) || 0;
  let req=parseInt(document.getElementById('reqScore').value) || 0;
  let actual=initial-deduct;
  document.getElementById('actualScore').value=actual;
  const status=document.getElementById('withdrawStatus');
  const lang = langSelect.value;
  if(actual>=req){
    status.textContent = i18n[lang].withdrawStatusAllowed || 'Allowed';
    status.className = 'badge green';
  } else if(actual>=71 && actual<=89){
    status.textContent = i18n[lang].withdrawStatusWaiting || 'Pending';
    status.className = 'badge orange';
  } else {
    status.textContent = i18n[lang].withdrawStatusVal || 'Not Allowed';
    status.className = 'badge red';
  }
}
document.getElementById('initialScore').addEventListener('input', updateActual);
document.getElementById('deductScore').addEventListener('input', updateActual);
document.getElementById('reqScore').addEventListener('input', updateActual);
updateActual();

// 当语言切换时也更新积分显示文本（如“允许提款”的文字）
langSelect.addEventListener('change', updateActual);

// ---------- 艺术字签名行为 ----------
// ---------- 艺术字签名行为 ----------
const sigDisplay = document.getElementById('signatureDisplay');
sigDisplay.addEventListener('input', ()=>{
  sigDisplay.style.fontFamily = '"Great Vibes", cursive'; // 艺术字
  sigDisplay.style.fontSize = '36px'; // 文字大小
  sigDisplay.style.color = '#222'; // 模拟墨水颜色
  sigDisplay.style.fontWeight = '400';
  sigDisplay.style.fontStyle = 'italic'; // 轻微倾斜，更像手写
  sigDisplay.style.letterSpacing = '1px'; // 调整字母间距
});


// ---------- PDF / PNG 导出（保留） ----------
async function exportAsPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p','mm','a4');
  // 使用 html2canvas 将合同区域渲染为图片
  const canvasEl = await html2canvas(document.getElementById('contract'), {scale:2});
  const imgData = canvasEl.toDataURL('image/png');
  const imgProps = doc.getImageProperties(imgData);
  const pdfWidth = doc.internal.pageSize.getWidth();
  const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
  doc.addImage(imgData,'PNG',0,0,pdfWidth,pdfHeight);
  doc.save('contract.pdf');
}
async function downloadPNG(){
  const canvasEl = await html2canvas(document.getElementById('contract'), {scale:2});
  const link = document.createElement('a');
  link.href = canvasEl.toDataURL('image/png');
  link.download = 'contract.png';
  link.click();
}

// ---------- 页面初始刷新（确保第一次加载时显示正确） ----------
refreshSignDate();
refreshExpireDate();

</script>
</body>
</html>
